---
sidebar: sidebar
permalink: task-prepare-restricted-mode.html
keywords: restricted mode requirements, requirements, install options, restricted mode networking, dark site, restricted mode permissions, permissions for restricted mode, networking for restricted mode
summary: Prepare your environment before you deploy BlueXP in restricted mode. For example, you need to review host requirements, prepare networking, set up permissions, and more.
---

= Prepare for deployment in restricted mode
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./media/

[.lead]
Prepare your environment before you deploy BlueXP in restricted mode. For example, you need to review host requirements, prepare networking, set up permissions, and more.

== Understand how restricted mode works

Before you get started, you should have an understanding of how BlueXP works in restricted mode.

For example, you should understand that you need to use the browser-based interface that is available locally from the BlueXP Connector that you need to install. You can't access BlueXP from the web-based console that's provided through the SaaS layer.

In addition, not all BlueXP services are available.

link:concept-modes.html[Learn how restricted mode works].

== Review installation options

In restricted mode, you can only install the Connector in the cloud. The following installation options are available:

* From the AWS Marketplace
* From the Azure Marketplace
* Manually installing the Connector on your own Linux host that's running in AWS, Azure, or Google Cloud

== Review host requirements

The Connector software must run on a host that meets specific operating system requirements, RAM requirements, port requirements, and so on.

When you deploy the Connector from the AWS or Azure Marketplace, the image includes the required OS and software components. You simply need to choose an instance type that meets CPU and RAM requirements.

include::_include/os-reqs.adoc[tag=start]

include::_include/os-reqs.adoc[tag=aws-ec2]

include::_include/os-reqs.adoc[tag=azure-vm]

include::_include/os-reqs.adoc[tag=google-machine]

include::_include/os-reqs.adoc[tag=end]

== Prepare networking for the Connector

Set up your networking so the Connector can manage resources and processes within your public cloud environment. Other than having a virtual network and subnet for the Connector, you'll need to ensure that the following requirements are met.

=== Connections to target networks

The Connector must have a network connection to the location where you plan to manage storage. For example, the VPC or VNet where you plan to deploy Cloud Volumes ONTAP, or the data center where your on-premises ONTAP clusters reside.

=== Outbound internet access for manual installs

include::_include/endpoints-manual-install.adoc[tag=start]
+
This endpoint is not required in Azure Government regions.

* \https://occmclientinfragov.azurecr.us
+
This endpoint is only required in Azure Government regions.

include::_include/endpoints-manual-install.adoc[tag=update]

=== Outbound internet access for day-to-day operations

The network location where you deploy the Connector must have an outbound internet connection. The Connector requires outbound internet access to contact the following endpoints in order to manage resources and processes within your public cloud environment.

[cols="2a,1a",options="header,autowidth"]
|===
| Endpoints
| Purpose

include::_include/endpoints-connector.adoc[tag=aws-endpoints]

include::_include/endpoints-connector.adoc[tag=azure-public-endpoints]

include::_include/endpoints-connector.adoc[tag=azure-gov-endpoints]

include::_include/endpoints-connector.adoc[tag=azure-china-endpoints]

include::_include/endpoints-connector.adoc[tag=google-cloud-endpoints]

include::_include/endpoints-connector.adoc[tag=nss-endpoints]

include::_include/endpoints-connector.adoc[tag=saas-endpoints]

include::_include/endpoints-connector.adoc[tag=upgrade-endpoints-restricted-mode]

|===

=== Proxy server

include::_include/proxy-server.adoc[]

=== Public IP address in Azure

include::_include/public-ip-azure.adoc[]

=== Ports

include::_include/ports.adoc[]

== Prepare networking for user access to BlueXP console

In restricted mode, the BlueXP user interface is accessible from the Connector. As you use the BlueXP user interface, it contacts a few endpoints to complete data management tasks. The machine running the web browser must have connections to the following endpoints.

[cols=2*,options="header,autowidth"]
|===
| Endpoints
| Purpose

| \https://signin.b2c.netapp.com
| Required to update NetApp Support Site (NSS) credentials or to add new NSS credentials to BlueXP.

|
\https://netapp-cloud-account.auth0.com

\https://cdn.auth0.com

\https://services.cloud.netapp.com
| Your web browser connects to these endpoints for centralized user authentication through BlueXP.

| \https://widget.intercom.io
| For in-product chat that enables you to talk to NetApp cloud experts.

|===

== Prepare cloud permissions

BlueXP requires permissions from your cloud provider to deploy Cloud Volumes ONTAP in a virtual network and to use BlueXP data services. You need to set up permissions in your cloud provider and then associate those permissions with the Connector.

To view the required steps, select the authentication option that you'd like to use for your cloud provider. 

// start tabbed area

[role="tabbed-block"]
====

.AWS IAM role
--
Use an IAM role to provide the Connector with permissions.

If you're creating the Connector from the AWS Marketplace, you'll be prompted to select that IAM role when you launch the EC2 instance. 

If you're manually installing the Connector on your own Linux host, you'll need to attach the role to the EC2 instance.

.Steps

include::_include/aws-permissions.adoc[tag=policy]

include::_include/aws-permissions.adoc[tag=role]

.Result

You now have an IAM role for the Connector EC2 instance.
--

.AWS access key
--
Set up permissions and an access key for an IAM user. You'll need to provide BlueXP with the AWS access key after you install the Connector and set up BlueXP.

.Steps

include::_include/aws-permissions.adoc[tag=policy]
+
Depending on the BlueXP services that you're planning to use, you might need to create a second policy.
+
For standard regions, the permissions are spread across two policies. Two policies are required due to a maximum character size limit for managed policies in AWS. link:reference-permissions-aws.html[Learn more about IAM policies for the Connector].

include::_include/aws-permissions.adoc[tag=keys]

.Result

The account now has the required permissions.
--

.Azure role
--
Create an Azure custom role with the required permissions. You'll assign this role to the Connector VM.

.Steps

. If you're planning to manually install the software on your own host, enable a system-assigned managed identity on the VM so that you can provide the required Azure permissions through a custom role.
+
https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm[Microsoft Azure documentation: Configure managed identities for Azure resources on a VM using the Azure portal^]

include::_include/azure-custom-role.adoc[]
--

.Azure service principal
--
Create and set up a service principal in Azure Active Directory and obtain the Azure credentials that BlueXP needs. You'll need to provide BlueXP with these credentials after you install the Connector and set up BlueXP.

.Create an Azure Active Directory application for role-based access control

. Ensure that you have permissions in Azure to create an Active Directory application and to assign the application to a role. 
+
For details, refer to https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#required-permissions/[Microsoft Azure Documentation: Required permissions^].

. From the Azure portal, open the *Azure Active Directory* service.
+
image:screenshot_azure_ad.gif[Shows the Active Directory service in Microsoft Azure.]

. In the menu, click *App registrations*.

. Click *New registration*.

. Specify details about the application:

* *Name*: Enter a name for the application.
* *Account type*: Select an account type (any will work with BlueXP).
* *Redirect URI*: You can leave this field blank.

. Click *Register*.
+
You've created the AD application and service principal.

.Assign the custom role to the application

. From the Azure portal, open the *Subscriptions* service.

. Select the subscription.

. Click *Access control (IAM) > Add > Add role assignment*.

. In the *Role* tab, select the *BlueXP Operator* role and click *Next*.

. In the *Members* tab, complete the following steps:

.. Keep *User, group, or service principal* selected.

.. Click *Select members*.
+
image:screenshot-azure-service-principal-role.png[A screenshot of the Azure portal that shows the Members tab when adding a role to an application.]

.. Search for the name of the application.
+
Here's an example:
+
image:screenshot_azure_service_principal_role.png[A screenshot of the Azure portal that shows the Add role assignment form in the Azure portal.]

.. Select the application and click *Select*.

.. Click *Next*.

. Click *Review + assign*.
+
The service principal now has the required Azure permissions to deploy the Connector.
+
If you want to deploy Cloud Volumes ONTAP from multiple Azure subscriptions, then you must bind the service principal to each of those subscriptions. BlueXP enables you to select the subscription that you want to use when deploying Cloud Volumes ONTAP.

.Add Windows Azure Service Management API permissions

. In the *Azure Active Directory* service, click *App registrations* and select the application.

. Click *API permissions > Add a permission*.

. Under *Microsoft APIs*, select *Azure Service Management*.
+
image:screenshot_azure_service_mgmt_apis.gif[A screenshot of the Azure portal that shows the Azure Service Management API permissions.]

. Click *Access Azure Service Management as organization users* and then click *Add permissions*.
+
image:screenshot_azure_service_mgmt_apis_add.gif[A screenshot of the Azure portal that shows adding the Azure Service Management APIs.]

.Get the application ID and directory ID for the application

. In the *Azure Active Directory* service, click *App registrations* and select the application.

. Copy the *Application (client) ID* and the *Directory (tenant) ID*.
+
image:screenshot_azure_app_ids.gif[A screenshot that shows the application (client) ID and directory (tenant) ID for an application in Azure Active Directory.]
+
When you add the Azure account to BlueXP, you need to provide the application (client) ID and the directory (tenant) ID for the application. BlueXP uses the IDs to programmatically sign in.

.Create a client secret

. Open the *Azure Active Directory* service.

. Click *App registrations* and select your application.

. Click *Certificates & secrets > New client secret*.

. Provide a description of the secret and a duration.

. Click *Add*.

. Copy the value of the client secret.
+
image:screenshot_azure_client_secret.gif[A screenshot of the Azure portal that shows a client secret for the Azure AD service principal.]
+
You now have a client secret that BlueXP can use it to authenticate with Azure AD.

.Result

Your service principal is now setup and you should have copied the application (client) ID, the directory (tenant) ID, and the value of the client secret. You need to enter this information in BlueXP when you add an Azure account.
--

.Google Cloud service account
--
Create a role and apply it to a service account that you'll use for the Connector VM instance.

.Steps

. Create a custom role in Google Cloud:

.. Create a YAML file that includes the permissions defined in the link:reference-permissions-gcp.html[Connector policy for Google Cloud].

.. From Google Cloud, activate cloud shell.

.. Upload the YAML file that includes the required permissions for the Connector.

.. Create a custom role by using the `gcloud iam roles create` command.
+
The following example creates a role named "connector" at the project level:
+
[source,gcloud]
gcloud iam roles create connector --project=myproject --file=connector.yaml
+
https://cloud.google.com/iam/docs/creating-custom-roles#iam-custom-roles-create-gcloud[Google Cloud docs: Creating and managing custom roles^]

. Create a service account in Google Cloud:

.. From the IAM & Admin service, click *Service Accounts > Create Service Account*.

.. Enter service account details and click *Create and Continue*.

.. Select the role that you just created.

.. Finish the remaining steps to create the role.
+
https://cloud.google.com/iam/docs/creating-managing-service-accounts#creating_a_service_account[Google Cloud docs: Creating a service account^]

.Result

You now have a service account that you can assign to the Connector VM instance.
--

====
// end tabbed area

== Enable Google Cloud APIs

Several APIs are required to deploy Cloud Volumes ONTAP in Google Cloud.

.Step

. https://cloud.google.com/apis/docs/getting-started#enabling_apis[Enable the following Google Cloud APIs in your project^]
+
include::_include/google-cloud-apis.adoc[]